name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up GCC
        uses: egor-tensin/setup-gcc@v1
        with:
          version: latest

      - name: Install NASM
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wcwidth colorama
          python -c "import unicodedata, json, os, sys, subprocess, time, threading, hashlib, shutil, traceback, fnmatch, pathlib, datetime, queue, concurrent.futures, typing; print('All standard library modules available')"

      - name: Build
        run: |
          python build.py --release

      - name: Run tests
        run: |
          echo "Running E# compiler tests..."
          echo 'function main() {' > test.esf
          echo '    print("Hello, E# World!");' >> test.esf
          echo '    print("Compiler test successful!");' >> test.esf
          echo '    return 0;' >> test.esf
          echo '}' >> test.esf
          echo "Testing basic compilation..."
          if [ -f "bin/e_sharp" ]; then
            echo "Created test file: test.esf"
            cat test.esf
            echo "Testing E# compiler basic compilation..."
            ./bin/e_sharp test.esf || exit 1
            echo "Testing E# compiler executable generation for Linux x86..."
            ./bin/e_sharp -t exe test.esf -o test_linux || exit 1
            if [ -f "test_linux" ]; then
              echo "Linux executable generated successfully!"
              chmod +x test_linux
              echo "Running generated Linux executable..."
              ./test_linux || exit 1
              echo "All tests passed!"
            else
              echo "Error: Linux executable not generated"
              exit 1
            fi
          else
            echo "Error: bin/e_sharp not found"
            ls -la bin/
            exit 1
          fi